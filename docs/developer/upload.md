# File upload and processing

## Upload

Files upload can happen in two ways:

1. Via form upload (subject or not on drag/drop)
2. Via the resumable upload protocol (subject or not on drag/drop)

From the user perspective the two approaches are mostly equal, but not on the backend implementation.
The form upload is synchrounous in the request, as the K-Box receives a request containing the file data, while the resumable upload is inheritly an asynchrounous process: the upload is started, but it could pause for a while before the K-Box can actually process the full file content.

To establishing a uniform document upload handling approach the _Asynchrounous Document Processing Pipeline_ is introduced.

The pipeline is based on the assumption that a `DocumentDescriptor` is always available and can assume different statuses, therefore a `DocumentDescriptor` can exists even if the file is not completly uploaded. 

The processing of the file is governed by events and the Laravel Queue.

In principles when an upload is finished a corresponding `UploadCompleted` event is triggered. This event is indepentent from the chosen upload mechanism, i.e. form or tus.

The `UploadCompleted` event listener will make sure the status of the `DocumentDescriptor` is `DocumentDescriptor::STATUS_UPLOAD_COMPLETED` and trigger the processing phase over the uploaded content, e.g. indexing it for search.

## Storage

Uploaded files are stored in a private space under `./storage/documents`.

Each upload is stored in a sub-folder structure based on year and month of upload and the file UUID. This is done mainly to prevent cases in which command iterating over the document list may hang the system, and to reduce the chance to reach the limits of files per folder.

The final path of a file will be 

```
./storage/documents/{year}/{month}/{file_uuid}/
```

e.g. `./storage/documents/2017/07/110ec58a-a0f2-4ac4-8393-c866d813b8d1`

> The filename is generated randomly and is not anymore connected to the original filename. This is done to reduce the chance that Unicode file names could not be stored on disk.

**File already existing**

For already existing files, the storage structure is not touched. The files are still located in `./storage/documents/{year}/{month}/` with the respective original filename


### File names

Files uploaded via form upload are saved in the storage with the original filename.

Files uploaded via TUS protocol are saved in the storage with the DocumentDescriptor UUID as filename. This is due to the fact that the TUS protocol don't take into consideration file names. The original filename is, therefore, only stored in the database as the result of the file upload authorization process.

## Upload Elaboration

> Experimental, not fully documented

An uploaded document is subject to a further elaboration after the upload completes succesfully.

The elaboration of an uploaded document consists in a set of actions executed sequentially that operates on the `DocumentDescriptor` generated by the file upload.

The actions are defined in the `$actions` array in the `KlinkDMS\DocumentsElaboration\Kernel` class.

Every action must extends the `KlinkDMS\Contracts\Action` class. The only method needed is called `run`. It receives the `DocumentDescriptor` to process. The `run` method must return the result of the elaboration.

An action might extract the title from the file, or guess the language of the file content.

The elaboration pipeline is triggered, after a file has been uploaded, by the dispatching of the `ElaborateDocument` job.

**error handling**

Action might fail. Throw an exceptions is a case of failure, while returning null is not considered a failure.

Throwing an exception can cause the entire pipeline to stop. If the action can fail and its computation discarded, then define the `$canFail` property on the class and set it to `true`

```php
protected $canFail = true;
```

In this case throwing an exception inside the `run` method will make the pipeline continue to the next step. The error is automatically logged.
